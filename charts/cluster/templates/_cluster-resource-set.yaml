{{- define "cluster.cluster-resource-set" -}}
{{- if eq .Values.install.enabled true -}}
{{- if or (eq .Values.install.strategy "ApplyOnce") (eq (include "hasApplyOnce" .Values.install.resources) "true") }}
---
apiVersion: addons.cluster.x-k8s.io/v1beta1
kind: ClusterResourceSet
metadata:
  name: {{ include "cluster-name" . }}-apply-once
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cluster.labels" . | nindent 4 }}
spec:
  strategy: ApplyOnce
  clusterSelector:
    matchLabels:
      name: {{ include "cluster-name" . }}
  resources:
  {{- range $k, $v := .Values.install.resources }}
  {{- if and $v.enabled (eq ($v.strategy | default $.Values.install.strategy ) "ApplyOnce" ) }}
  {{- if $v.createNamespace }}
  - name: manifests-00-{{ $k }}-ns
    kind: Secret
  {{- end }}
  {{- if not $v.onlyNamespace }}
  {{- range until ($v.secretsCount | default 1 | int) }}
  - name: manifests-{{ $k }}-{{ . }}
    kind: Secret
  {{- end }}
  {{- end }}
  {{- end }}
  {{- end }}
{{- end }}
{{- if or (eq .Values.install.strategy "Reconcile") (eq (include "hasReconcile" .Values.install.resources) "true") }}
---
apiVersion: addons.cluster.x-k8s.io/v1beta1
kind: ClusterResourceSet
metadata:
  name: {{ include "cluster-name" . }}-reconcile
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cluster.labels" . | nindent 4 }}
spec:
  strategy: Reconcile
  clusterSelector:
    matchLabels:
      name: {{ include "cluster-name" . }}
  resources:
  {{- range $k, $v := .Values.install.resources }}
  {{- if and $v.enabled (eq ($v.strategy | default $.Values.install.strategy ) "Reconcile" ) }}
  {{- if $v.createNamespace }}
  - name: manifests-00-{{ $k }}-ns
    kind: Secret
  {{- end }}
  {{- if not $v.onlyNamespace }}
  {{- range until ($v.secretsCount | default 1 | int) }}
  - name: manifests-{{ $k }}-{{ . }}
    kind: Secret
  {{- end }}
  {{- end }}
  {{- end }}
  {{- end }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "cluster-name" . }}-install
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: "install"
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: {{ include "cluster-name" . }}
    app.kubernetes.io/part-of: "cluster"
    app.kubernetes.io/version: {{ .Chart.Version }}
stringData:
  render.sh: |-
    #!/usr/bin/env bash
    set -eu

    cd /tmp
    {{- range $k, $v := .Values.install.resources }}
    {{- if $v.enabled }}
    {{- if $v.createNamespace }}
    kubectl create ns {{ $v.namespace }} --dry-run=client -o yaml > manifests-00-{{ $k }}-ns.yaml
    kubectl create secret generic manifests-00-{{ $k }}-ns \
      --from-file=manifests-00-{{ $k }}-ns.yaml \
      --type=addons.cluster.x-k8s.io/resource-set \
      -n {{ $.Release.Namespace }} \
      -o json --dry-run=client \
      | kubectl apply --server-side --force-conflicts -f-
    {{- end }}
    {{- if not $v.onlyNamespace }}

    {{- if $v.values }}
    cat >values_{{ $k }}.yaml <<EOL
    {{- (tpl $v.values $) | nindent 4 }}
    EOL
    {{- else }}
    echo "---" > values_{{ $k }}.yaml
    {{- end }}

    {{- if $v.chart }}
    {{- if $v.repoCreds }}
    helm repo add {{ $k }} {{ $v.repoUrl }} \
      --username "{{ $v.repoCreds.username }}" \
      --password "{{ $v.repoCreds.password }}"
    {{- else }}
    helm repo add {{ $k }} {{ $v.repoUrl }}
    {{- end }}
    helm repo update {{ $k }} >/dev/null
    {{- end }}
    echo "---" > manifests_{{ $k }}.yaml
    helm template \
      {{ $v.releaseName }} \
      {{- if $v.chart }}
      {{ $k }}/{{ $v.chart }} \
      {{- else }}
      {{ $v.repoUrl }} \
      {{- end }}
      --include-crds \
      --kube-version {{ $.Values.install.k8sVersion }} \
      --version {{ $v.version }} \
      --namespace {{ $v.namespace }} \
      -f values_{{ $k }}.yaml >> manifests_{{ $k }}.yaml
    # Remove "description" keys from CRDs to reduce the size
    # yq -i -o=yaml -I=2 'del(.. | select(has("description")).description)' manifests_{{ $k }}.yaml

    awk '/---/{f="manifests_{{ $k }}-"(++i%{{- $v.secretsCount | default 1 | int }});}{print > f;}' manifests_{{ $k }}.yaml
    {{- range until ($v.secretsCount | default 1 | int) }}
    # Convert into json to reduce the size, limit is 1048576 bytes (1 mb)
    yq -o=json -I=0 manifests_{{ $k }}-{{ . }} | jq -sc . > manifests_{{ $k }}-{{ . }}.json
    # cat manifests_{{ $k }}-{{ . }}.json | sed -e '/^[[:space:]]*$/d' -e 's/^/---\n/' > manifests_{{ $k }}-{{ . }}.yaml
    kubectl create secret generic manifests-{{ $k }}-{{ . }} \
      --from-file=manifests_{{ $k }}-{{ . }}.json \
      --type=addons.cluster.x-k8s.io/resource-set \
      -n {{ $.Release.Namespace }} \
      -o json --dry-run=client \
      | jq '.metadata.labels |= {"{{ $.Values.install.secretLabel.key }}":"{{ $.Values.install.secretLabel.value }}"}' \
      | kubectl apply --server-side --force-conflicts -f-
    {{- end }}
    {{- end }}
    {{- end }}
    {{- end }}
    # ls -lah
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "cluster-name" . }}-install
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: "install"
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: {{ include "cluster-name" . }}
    app.kubernetes.io/part-of: "cluster"
    app.kubernetes.io/version: {{ .Chart.Version }}
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    # argocd.argoproj.io/sync-wave: "10"
spec:
  template:
    metadata:
      name: {{ include "cluster-name" . }}-install
      labels:
        app.kubernetes.io/component: "install"
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: {{ include "cluster-name" . }}
        app.kubernetes.io/part-of: "cluster"
        app.kubernetes.io/version: {{ .Chart.Version }}
    spec:
      serviceAccountName: {{ include "cluster-name" . }}-install
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: install
        image: {{ $.Values.install.jobImage }}
        command:
        - "/bin/bash"
        - "/scripts/render.sh"
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
        volumeMounts:
        - name: script-volume
          mountPath: /scripts
          readOnly: true
        - name: tmp
          mountPath: /tmp
        env:
        - name: HOME
          value: /tmp
        - name: XDG_CONFIG_HOME
          value: /tmp/.config
        - name: HELM_CONFIG_HOME
          value: /tmp/.config/helm
        - name: HELM_CACHE_HOME
          value: /tmp/.cache/helm
        - name: HELM_DATA_HOME
          value: /tmp/.local/share/helm
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          seccompProfile:
            type: RuntimeDefault
      volumes:
      - name: script-volume
        secret:
          secretName: {{ include "cluster-name" . }}-install
      - name: tmp
        emptyDir: {}
  backoffLimit: 3
  parallelism: 1
  completions: 1
{{- else if eq .Values.install.deleteAll false -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "cluster-name" . }}-cleanup
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: "cleanup"
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: {{ include "cluster-name" . }}
    app.kubernetes.io/part-of: "cluster"
    app.kubernetes.io/version: {{ .Chart.Version }}
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    # argocd.argoproj.io/sync-wave: "10"
spec:
  template:
    metadata:
      name: {{ include "cluster-name" . }}-cleanup
      labels:
        app.kubernetes.io/component: "cleanup"
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: {{ include "cluster-name" . }}
        app.kubernetes.io/part-of: "cluster"
        app.kubernetes.io/version: {{ .Chart.Version }}
    spec:
      serviceAccountName: {{ include "cluster-name" . }}-install
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: cleanup
        image: {{ $.Values.install.jobImage }}
        command:
        - "/bin/bash"
        args:
        - "-c"
        - |
          kubectl delete secret -l '{{ $.Values.install.secretLabel.key }}={{ $.Values.install.secretLabel.value }}' -n {{ $.Release.Namespace }} --ignore-not-found=true
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "128Mi"
        env:
        - name: HOME
          value: /tmp
        - name: XDG_CONFIG_HOME
          value: /tmp/.config
        - name: HELM_CONFIG_HOME
          value: /tmp/.config/helm
        - name: HELM_CACHE_HOME
          value: /tmp/.cache/helm
        - name: HELM_DATA_HOME
          value: /tmp/.local/share/helm
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          seccompProfile:
            type: RuntimeDefault
  backoffLimit: 3
  parallelism: 1
  completions: 1
{{- end }}
{{ if or (eq .Values.install.enabled true) (eq .Values.install.deleteAll false) -}}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "cluster-name" . }}-install
  namespace: {{ .Release.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "cluster-name" . }}-install
  namespace: {{ .Release.Namespace }}
rules:
- apiGroups:
  - ""
  resources:
  - "secrets"
  verbs:
{{- if eq .Values.install.enabled true }}
  - "get"
  - "patch"
  - "create"
{{- else }}
  - "list"
  - "delete"
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "cluster-name" . }}-install
  namespace: {{ .Release.Namespace }}
subjects:
- kind: ServiceAccount
  name: {{ include "cluster-name" . }}-install
roleRef:
  kind: Role
  name: {{ include "cluster-name" . }}-install
  apiGroup: rbac.authorization.k8s.io
{{- if eq .Values.install.enabled true }}
{{- with .Values.install.extraRoles }}
---
{{ tpl . $ }}
{{- end }}
{{- end }}
{{- end }}
{{- end -}}
